<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Tableau de bord M√©t√©o Aveyron</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
<style>
/* ---------------- BODY ---------------- */
body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; margin:0; height:100vh; }

/* ---------------- LOGIN ---------------- */
#login-container { 
  max-width: 400px; 
  margin:auto; 
  padding:20px; 
  background:#fff; 
  border-radius:12px; 
  box-shadow:0 4px 12px rgba(0,0,0,0.2); 
  text-align:center; 
  position: relative; 
  z-index: 10;
  color: white;
}
#login-container::before {
  content: "";
  position: fixed;
  top:0; left:0; right:0; bottom:0;
  background: url('https://m.media-amazon.com/images/I/71zvVSjBE+L._AC_UF894,1000_QL80_.jpg') center/cover no-repeat;
  filter: blur(8px) brightness(0.6);
  z-index: -1;
}
#login-container input { margin-bottom:10px; width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; }
#login-container button { width:100%; padding:10px; border-radius:6px; }
#login-message { display:block; margin-top:10px; color:red; font-weight:bold; }

/* ---------------- TABLEAU DE BORD ---------------- */
.container { max-width: 1200px; margin:auto; display:none; }
.card { margin-bottom: 20px; }
.card-header { font-weight:bold; font-size:1.1rem; }
.icon-preview { width:50px; height:50px; object-fit:contain; }
</style>
</head>
<body>

<!-- ---------------- LOGIN ---------------- -->
<div id="login-container">
  <h3>üå©Ô∏è Connexion Pr√©visions</h3>
  <input type="email" id="login-email" placeholder="Email" />
  <input type="password" id="login-password" placeholder="Mot de passe" />
  <button id="login-btn">Se connecter</button>
  <span id="login-message"></span>
</div>

<!-- ---------------- TABLEAU DE BORD ---------------- -->
<div class="container">
<h1 class="mb-4">Tableau de bord pr√©visions - MeteoAveyron - OBserveV2</h1>

<div class="card">
<div class="card-header">S√©lection du jour</div>
<div class="card-body d-flex align-items-center gap-3">
<select id="day-select" class="form-select w-25">
<option value="today">Aujourd'hui</option>
<option value="tomorrow">Demain</option>
</select>
<button id="update-map" class="btn btn-primary">Mettre √† jour la carte</button>
<span id="current-date" class="ms-3 fw-bold"></span>
</div>
</div>

<div class="card">
<div class="card-header">P√©riodes</div>
<div class="card-body d-flex gap-2">
<button class="btn btn-primary period-btn" data-period="morning">Matin</button>
<button class="btn btn-primary period-btn" data-period="day">Journ√©e</button>
<button class="btn btn-primary period-btn" data-period="evening">Soir√©e</button>
<button class="btn btn-warning period-btn" data-period="wind">Vent</button>
</div>
</div>

<div class="card">
<div class="card-header">Conditions m√©t√©o</div>
<div class="card-body">
<div class="row g-3" id="cities-container">
<!-- Les villes seront inject√©es ici -->
</div>
</div>
</div>

<div class="card">
<div class="card-header">Description</div>
<div class="card-body">
<textarea id="description-text" class="form-control" rows="4"></textarea>
<button id="save-description" class="btn btn-success mt-2">Sauvegarder la description</button>
</div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

// ---------------- FIREBASE ----------------
const firebaseConfig = {
 apiKey: "AIzaSyCpWWE-v4vAiQt4P-eogE7sUZ3WGODSPj4",
 authDomain: "previsions-meteo.firebaseapp.com",
 databaseURL: "https://previsions-meteo-default-rtdb.firebaseio.com",
 projectId: "previsions-meteo",
 storageBucket: "previsions-meteo.firebasestorage.app",
 messagingSenderId: "334857892553",
 appId: "1:334857892553:web:7aa0afbb7251f145911318"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

// ---------------- LOGIN ----------------
const loginBtn = document.getElementById('login-btn');
const loginMessage = document.getElementById('login-message');
loginBtn.addEventListener('click', async () => {
  const email = document.getElementById('login-email').value;
  const password = document.getElementById('login-password').value;

  try {
    await signInWithEmailAndPassword(auth, email, password);
    loginMessage.innerText = "Connect√© !";
    document.getElementById('login-container').style.display = 'none';
    document.querySelector('.container').style.display = 'block';
    await adjustDatesIfNeeded(); 
    renderCities();
    loadDescription();
    updateCurrentDate(); 
  } catch(error) {
    loginMessage.innerText = "Erreur : " + error.message;
  }
});

// ---------------- DONN√âES ----------------
const CONDITIONS = {
 soleil:{label:"Ensoleill√©",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/soleil-high-5ydohv.png"},
 soleil_nuages:{label:"Ensoleill√© avec nuages possibles",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/soleil-et-nuage-high.png?enable-io=true&width=532"},
 eclaircies:{label:"√©claircies possibles",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/eclaircies-high.png?enable-io=true&width=532"},
 nuageux:{label:"Nuageux",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/nuageux-high-nctmr4.png?enable-io=true&width=532"},
 averses_localis√©es:{label:"Averses Localis√©es",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/passages-pluvieux-high-qpysrh.png?enable-io=true&width=532"},
 pluie_faible:{label:"Pluie faible",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/pluie-faible-high-lwo4k5.png"},
 pluie_moderee:{label:"Pluie mod√©r√©e",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/pluie-mod-r-high-omk8vs.png"},
 pluie_forte:{label:"Forte pluie ‚ö†Ô∏è",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/pluie-forte-high.png?enable-io=true&width=532"},
 orage:{label:"Orages possibles",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/orage-high-2ijlyg.png"},
 orage_isol√©:{label:"Risque d'orages isol√©es",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/passages-orageux-high-6ppgfs.png?enable-io=true&width=532"},
 orage_violent:{label:"Risque d'orages violents ‚ö†Ô∏è",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/orage-fort-high.png?enable-io=true&width=532"},
 neige_localis√©e:{label:"Neige localis√©e",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/neige-claircies-high-ajzfn1.png?enable-io=true&width=532"},
 neige_faible:{label:"Faibles chutes de neige",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/neige-faible-high-goeaq0.png?enable-io=true&width=532"},
 neige_mod√©r√©:{label:"Chutes de neige mod√©r√©es",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/neige-mod-r-high-hw687j.png?enable-io=true&width=532"},
 neige_forte:{label:"Fortes chutes de neige ‚ö†Ô∏è",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/neige-forte-high.png?enable-io=true&width=532"},
 pluie_neige:{label:"Pluies et neige m√™l√©es",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/copie_de_copie_de_aesthetic_phone_mockup_instagram_post__9_-removebg-preview-high.png?enable-io=true&width=532"},
 brouillard_givrant_possible:{label:"Brouillard givrant possible ‚ö†Ô∏è",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/copie_de_copie_de_aesthetic_phone_mockup_instagram_post__12_-removebg-preview-high.png?enable-io=true&width=532"},
 brouillard_givrant:{label:"Brouillard givrant ‚ö†Ô∏è",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/copie_de_copie_de_aesthetic_phone_mockup_instagram_post__5_-removebg-preview-high.png?enable-io=true&width=532"},
 brouillard:{label:"Brouillard possible",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/brouillard-high.png?enable-io=true&crop=1.4577%3A1%2Coffset-y55&width=532"},
 vent_faible:{label:"Vent faible",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/logo_initiale_marron-_gourmand_-l-gant_minimaliste-removebg-preview-high.png"},
 vent_modere:{label:"Vent mod√©r√©",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/logo_initiale_marron-_gourmand_-l-gant_minimaliste__1_-removebg-preview-high-062t0p.png"},
 vent_fort:{label:"Vent fort",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/logo_initiale_marron-_gourmand_-l-gant_minimaliste__2_-removebg-preview-removebg-preview-high.png"},
 vent_tres_fort:{label:"Vent tr√®s fort",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/logo_initiale_marron-_gourmand_-l-gant_minimaliste__3_-removebg-preview-high.png"}
};

const CITIES = ["Rodez","Millau","Decazeville","Villefranche-de-Rouergue"];
let currentPeriod = "morning";
let currentDay = "today";

// ---------------- AJUSTER LES DATES √Ä MINUIT ----------------
async function adjustDatesIfNeeded(){
  // Simuler la date du jour pour tests : const todayStr = "2026-01-28";
  const todayStr = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
  const dateRef = ref(db,'dateReference');
  const snap = await get(dateRef);

  if(!snap.exists() || snap.val()!==todayStr){
    const todayRef = ref(db,'today');
    const tomorrowRef = ref(db,'tomorrow');
    const tomorrowSnap = await get(tomorrowRef);

    if(tomorrowSnap.exists() && Object.keys(tomorrowSnap.val()).length>0){
      await set(todayRef, tomorrowSnap.val()); // copie demain ‚Üí aujourd‚Äôhui
    }
    await set(tomorrowRef, {}); // vide demain
    await set(dateRef, todayStr);
    console.log("Dates ajust√©es automatiquement pour le nouveau jour :", todayStr);
  }
}

// ---------------- AFFICHER LA DATE ----------------
function updateCurrentDate(){
  const dateDisplay = document.getElementById('current-date');
  get(ref(db,currentDay)).then(snap=>{
    if(snap.exists() && snap.val().dateStr){
      dateDisplay.innerText = snap.val().dateStr;
    } else {
      const baseDate = new Date();
      if(currentDay==='tomorrow') baseDate.setDate(baseDate.getDate()+1);
      dateDisplay.innerText = baseDate.toLocaleDateString('fr-FR', { weekday:'long', day:'2-digit', month:'long' });
    }
  });
}

// ---------------- RENDER VILLES ----------------
const container = document.getElementById('cities-container');
function renderCities(){
 container.innerHTML = '';
 CITIES.forEach(city=>{
  const col = document.createElement('div');
  col.className = 'col-md-3';
  col.innerHTML = `<div class="card p-2">
   <div class="mb-2"><strong>${city}</strong></div>
   <select class="form-select condition-select"></select>
   <img class="icon-preview mt-2" src="" alt="ic√¥ne"/>
   <button class="btn btn-success btn-sm mt-2 save-btn">Sauvegarder</button>
  </div>`;
  container.appendChild(col);
  const select = col.querySelector('.condition-select');
  const img = col.querySelector('.icon-preview');
  const saveBtn = col.querySelector('.save-btn');

  Object.keys(CONDITIONS).forEach(key=>{
   const opt = document.createElement('option');
   opt.value = key; opt.text = CONDITIONS[key].label;
   select.appendChild(opt);
  });

  const cityRef = ref(db, `${currentDay}/${currentPeriod}/${city}`);
  onValue(cityRef, snap=>{
   if(snap.exists()){
    select.value = snap.val();
    img.src = CONDITIONS[snap.val()].icon;
   } else {
    select.value = currentPeriod.includes('vent')?'vent_faible':'soleil';
    img.src = CONDITIONS[select.value].icon;
   }
  });

  select.addEventListener('change',()=>{ img.src = CONDITIONS[select.value].icon; });

  saveBtn.addEventListener('click',()=>{ 
   set(ref(db, `${currentDay}/${currentPeriod}/${city}`), select.value); 
   alert(`${city} - ${currentPeriod} (${currentDay}) mis √† jour !`); 
  });
 });
}

// ---------------- PERIODES ----------------
document.querySelectorAll('.period-btn').forEach(btn=>{
 btn.addEventListener('click',()=>{
  document.querySelectorAll('.period-btn').forEach(b=>b.classList.remove('btn-success')); 
  btn.classList.add('btn-success');
  currentPeriod = btn.dataset.period;
  renderCities();
  loadDescription();
 });
});

// ---------------- DAY ----------------
document.getElementById('day-select').addEventListener('change',(e)=>{
 currentDay = e.target.value;
 updateCurrentDate(); 
 renderCities();
 loadDescription();
});

// ---------------- DESCRIPTION ----------------
const descTextarea = document.getElementById('description-text');
function loadDescription(){
 const descRef = ref(db, `descriptions/${currentDay}/${currentPeriod}`);
 onValue(descRef, snap=>{ descTextarea.value = snap.exists()? snap.val() : ''; });
}
document.getElementById('save-description').addEventListener('click',()=>{
 set(ref(db, `descriptions/${currentDay}/${currentPeriod}`), descTextarea.value);
 alert(`Description ${currentPeriod} pour ${currentDay} mise √† jour !`);
});

// ---------------- BOUTON METTRE √Ä JOUR CARTE ----------------
const updateBtn = document.getElementById('update-map');
updateBtn.addEventListener('click', async ()=>{
 const displayedRef = ref(db,'displayedDay');
 const snap = await get(displayedRef);
 const currentDisplayed = snap.exists()? snap.val():'today';
 if(currentDisplayed==='today'){
   await set(displayedRef,'tomorrow');
   updateBtn.textContent = "Revenir au jour j";
 } else {
   await set(displayedRef,'today');
   updateBtn.textContent = "Mettre √† jour la carte";
 }
 alert("Carte publique mise √† jour !");
});
</script>
</body>
</html>
