<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Tableau de bord Météo Aveyron</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
<style>
body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; }
#login-container { max-width: 400px; margin:auto; padding:20px; background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.2); text-align:center; }
#login-container input { margin-bottom:10px; width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; }
#login-container button { width:100%; padding:10px; border-radius:6px; }
#login-message { display:block; margin-top:10px; color:red; font-weight:bold; }

.container { max-width: 1200px; margin:auto; display:none; }
.card { margin-bottom: 20px; }
.card-header { font-weight:bold; font-size:1.1rem; }
.icon-preview { width:50px; height:50px; object-fit:contain; }
</style>
</head>
<body>

<!-- ---------------- LOGIN ---------------- -->
<div id="login-container">
  <h3>Connexion Tableau de bord</h3>
  <input type="email" id="login-email" placeholder="Email" />
  <input type="password" id="login-password" placeholder="Mot de passe" />
  <button id="login-btn">Se connecter</button>
  <span id="login-message"></span>
</div>

<!-- ---------------- TABLEAU DE BORD ---------------- -->
<div class="container">
<h1 class="mb-4">Tableau de bord météo Aveyron</h1>

<div class="card">
<div class="card-header">Sélection du jour</div>
<div class="card-body d-flex align-items-center gap-3">
<select id="day-select" class="form-select w-25">
<option value="today">Aujourd'hui</option>
<option value="tomorrow">Demain</option>
</select>
<button id="update-map" class="btn btn-primary">Mettre à jour la carte</button>
</div>
</div>

<div class="card">
<div class="card-header">Périodes</div>
<div class="card-body d-flex gap-2">
<button class="btn btn-primary period-btn" data-period="morning">Matin</button>
<button class="btn btn-primary period-btn" data-period="day">Journée</button>
<button class="btn btn-primary period-btn" data-period="evening">Soirée</button>
<button class="btn btn-warning period-btn" data-period="wind">Vent</button>
</div>
</div>

<div class="card">
<div class="card-header">Modifier les conditions météo</div>
<div class="card-body">
<div class="row g-3" id="cities-container">
<!-- Les villes seront injectées ici -->
</div>
</div>
</div>

<div class="card">
<div class="card-header">Description</div>
<div class="card-body">
<textarea id="description-text" class="form-control" rows="4"></textarea>
<button id="save-description" class="btn btn-success mt-2">Sauvegarder la description</button>
</div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

// ---------------- FIREBASE ----------------
const firebaseConfig = {
 apiKey: "AIzaSyCpWWE-v4vAiQt4P-eogE7sUZ3WGODSPj4",
 authDomain: "previsions-meteo.firebaseapp.com",
 databaseURL: "https://previsions-meteo-default-rtdb.firebaseio.com",
 projectId: "previsions-meteo",
 storageBucket: "previsions-meteo.firebasestorage.app",
 messagingSenderId: "334857892553",
 appId: "1:334857892553:web:7aa0afbb7251f145911318"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

// ---------------- LOGIN ----------------
const loginBtn = document.getElementById('login-btn');
const loginMessage = document.getElementById('login-message');
loginBtn.addEventListener('click', () => {
  const email = document.getElementById('login-email').value;
  const password = document.getElementById('login-password').value;

  signInWithEmailAndPassword(auth, email, password)
    .then(userCredential => {
      loginMessage.innerText = "Connecté !";
      document.getElementById('login-container').style.display = 'none';
      document.querySelector('.container').style.display = 'block';
      adjustDatesIfNeeded(); // Ajuster dates au login
      renderCities();
      loadDescription();
    })
    .catch(error => {
      loginMessage.innerText = "Erreur : " + error.message;
    });
});

// ---------------- DONNÉES ----------------
const CONDITIONS = {
 soleil:{label:"Ensoleillé",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/soleil-high-5ydohv.png"},
 pluie_faible:{label:"Pluie faible",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/pluie-faible-high-lwo4k5.png"},
 pluie_moderee:{label:"Pluie modérée",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/pluie-mod-r-high-omk8vs.png"},
 orage:{label:"Orages",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/orage-high-2ijlyg.png"},
 vent_faible:{label:"Vent faible",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/logo_initiale_marron-_gourmand_-l-gant_minimaliste-removebg-preview-high.png"},
 vent_modere:{label:"Vent modéré",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/logo_initiale_marron-_gourmand_-l-gant_minimaliste__1_-removebg-preview-high-062t0p.png"},
 vent_fort:{label:"Vent fort",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/logo_initiale_marron-_gourmand_-l-gant_minimaliste__2_-removebg-preview-removebg-preview-high.png"},
 vent_tres_fort:{label:"Vent très fort",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/logo_initiale_marron-_gourmand_-l-gant_minimaliste__3_-removebg-preview-high.png"}
};

const CITIES = ["Rodez","Millau","Decazeville","Villefranche-de-Rouergue"];
let currentPeriod = "morning";
let currentDay = "today";

// ---------------- AJUSTER LES DATES À MINUIT ----------------
async function adjustDatesIfNeeded(){
  const dateRef = ref(db,'dateReference');
  const snap = await get(dateRef);
  const todayStr = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
  if(!snap.exists() || snap.val()!==todayStr){
    // Décaler tomorrow → today
    const todayRef = ref(db,'today');
    const tomorrowRef = ref(db,'tomorrow');
    const tomorrowSnap = await get(tomorrowRef);
    if(tomorrowSnap.exists() && Object.keys(tomorrowSnap.val()).length > 0){
      await set(todayRef, tomorrowSnap.val());
    }
    // Réinitialiser tomorrow vide pour j+1
    await set(tomorrowRef, {});
    await set(dateRef, todayStr);
    console.log("Dates ajustées automatiquement pour le nouveau jour :", todayStr);
  }
}

// ---------------- RENDER VILLES ----------------
const container = document.getElementById('cities-container');
function renderCities(){
 container.innerHTML = '';
 CITIES.forEach(city=>{
  const col = document.createElement('div');
  col.className = 'col-md-3';
  col.innerHTML = `<div class="card p-2">
   <div class="mb-2"><strong>${city}</strong></div>
   <select class="form-select condition-select"></select>
   <img class="icon-preview mt-2" src="" alt="icône"/>
   <button class="btn btn-success btn-sm mt-2 save-btn">Sauvegarder</button>
  </div>`;
  container.appendChild(col);
  const select = col.querySelector('.condition-select');
  const img = col.querySelector('.icon-preview');
  const saveBtn = col.querySelector('.save-btn');

  Object.keys(CONDITIONS).forEach(key=>{
   const opt = document.createElement('option');
   opt.value = key; opt.text = CONDITIONS[key].label;
   select.appendChild(opt);
  });

  const cityRef = ref(db, `${currentDay}/${currentPeriod}/${city}`);
  onValue(cityRef, snap=>{
   if(snap.exists()){
    select.value = snap.val();
    img.src = CONDITIONS[snap.val()].icon;
   } else {
    select.value = currentPeriod.includes('vent')?'vent_faible':'soleil';
    img.src = CONDITIONS[select.value].icon;
   }
  });

  select.addEventListener('change',()=>{ img.src = CONDITIONS[select.value].icon; });

  saveBtn.addEventListener('click',()=>{ 
   set(ref(db, `${currentDay}/${currentPeriod}/${city}`), select.value); 
   alert(`${city} - ${currentPeriod} (${currentDay}) mis à jour !`); 
  });
 });
}

// ---------------- PERIODES ----------------
document.querySelectorAll('.period-btn').forEach(btn=>{
 btn.addEventListener('click',()=>{
  document.querySelectorAll('.period-btn').forEach(b=>b.classList.remove('btn-success')); 
  btn.classList.add('btn-success');
  currentPeriod = btn.dataset.period;
  renderCities();
  loadDescription();
 });
});

// ---------------- DAY ----------------
document.getElementById('day-select').addEventListener('change',(e)=>{
 currentDay = e.target.value;
 renderCities();
 loadDescription();
});

// ---------------- DESCRIPTION ----------------
const descTextarea = document.getElementById('description-text');
function loadDescription(){
 const descRef = ref(db, `descriptions/${currentDay}/${currentPeriod}`);
 onValue(descRef, snap=>{ descTextarea.value = snap.exists()? snap.val() : ''; });
}
document.getElementById('save-description').addEventListener('click',()=>{
 set(ref(db, `descriptions/${currentDay}/${currentPeriod}`), descTextarea.value);
 alert(`Description ${currentPeriod} pour ${currentDay} mise à jour !`);
});

// ---------------- BOUTON METTRE À JOUR CARTE ----------------
const updateBtn = document.getElementById('update-map');
updateBtn.addEventListener('click', async ()=>{
 const displayedRef = ref(db,'displayedDay');
 const snap = await get(displayedRef);
 const currentDisplayed = snap.exists()? snap.val():'today';
 if(currentDisplayed==='today'){
   await set(displayedRef,'tomorrow');
   updateBtn.textContent = "Revenir au jour j";
 } else {
   await set(displayedRef,'today');
   updateBtn.textContent = "Mettre à jour la carte";
 }
 alert("Carte publique mise à jour !");
});
</script>
</body>
</html>
