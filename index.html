<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Tableau de bord M√©t√©o Aveyron</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
<style>

.container h1 {
    color: #ffffff;
    text-shadow: 0 2px 6px rgba(0,0,0,0.6);
}


body::before {
    content: "";
    position: fixed;
    top:0; left:0; width:100%; height:100%;
    background: url('https://t4.ftcdn.net/jpg/07/24/00/11/360_F_724001193_eKGDuOZwvJoLt2zYHQQuFyyf2kQh7qEP.jpg') no-repeat center center;
    background-size: cover;
    filter: blur(15px);
    z-index: -1;
}
body::after {
    content: "";
    position: fixed;
    top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.3);
    z-index: -1;
}
body { font-family: 'Segoe UI', sans-serif; padding:20px; margin:0; }
#login-container { 
    max-width: 400px; 
    margin:auto; 
    padding:20px; 
    background: rgba(255,255,255,0.25);
    border-radius:12px; 
    box-shadow:0 4px 12px rgba(0,0,0,0.2); 
    text-align:center; 
    position: relative; 
    z-index: 10;
    color: #ffffff;

}

.icon-preview {
    width:150px;
    height:150px;
    object-fit:contain;
    display: block;
    margin: 10px auto 0;
}


#login-container input { margin-bottom:10px; width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; }
#login-container button { width:100%; padding:10px; border-radius:6px; }
#login-message { display:block; margin-top:10px; color:red; font-weight:bold; }

.container { max-width: 1200px; margin:auto; display:none; }
.card { margin-bottom: 20px; }
.card-header { font-weight:bold; font-size:1.1rem; }
</style>
</head>
<body>

<div id="login-container">
  <h3>üå©Ô∏è Connexion Pr√©visions</h3>
  <input type="email" id="login-email" placeholder="Email" />
  <input type="password" id="login-password" placeholder="Mot de passe" />
  <button id="login-btn">Se connecter</button>
  <span id="login-message"></span>
</div>

<div class="container">
<h1 class="mb-4">Tableau de bord pr√©visions - MeteoAveyron | OBserveV1</h1>

<div class="card">
<div class="card-header">S√©lection de la date</div>
<div class="card-body d-flex align-items-center gap-3">
<input type="date" id="date-select" class="form-control w-25"/>
<span id="current-date" class="ms-3 fw-bold"></span>
</div>
</div>

<div class="card">
<div class="card-header">P√©riodes</div>
<div class="card-body d-flex gap-2">
<button class="btn btn-primary period-btn" data-period="morning">Matin</button>
<button class="btn btn-primary period-btn" data-period="day">Journ√©e</button>
<button class="btn btn-primary period-btn" data-period="evening">Soir√©e</button>
<button class="btn btn-warning period-btn" data-period="wind">Pr√©vision vent</button>
</div>
</div>

<div class="card">
<div class="card-header">Conditions m√©t√©o</div>
<div class="card-body">
<div class="row g-3" id="cities-container"></div>
</div>
</div>

<div class="card">
<div class="card-header">Description</div>
<div class="card-body">
<textarea id="description-text" class="form-control" rows="4"></textarea>
</div>
</div>

<button id="save-all" class="btn btn-success mt-3">Sauvegarder</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

const firebaseConfig = {
 apiKey: "AIzaSyCpWWE-v4vAiQt4P-eogE7sUZ3WGODSPj4",
 authDomain: "previsions-meteo.firebaseapp.com",
 databaseURL: "https://previsions-meteo-default-rtdb.firebaseio.com",
 projectId: "previsions-meteo",
 storageBucket: "previsions-meteo.firebasestorage.app",
 messagingSenderId: "334857892553",
 appId: "1:334857892553:web:7aa0afbb7251f145911318"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

// ---------------- DONN√âES ----------------
const CONDITIONS = {
 soleil:{label:"Ensoleill√©",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/soleil-high-5ydohv.png"},
 soleil:{label:"Ensoleill√©",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/soleil-high-5ydohv.png"},
 soleil_nuages:{label:"Ensoleill√© avec nuages possibles",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/soleil-et-nuage-high.png?enable-io=true&width=532"},
 eclaircies:{label:"√©claircies possibles",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/eclaircies-high.png?enable-io=true&width=532"},
 nuageux:{label:"Nuageux",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/nuageux-high-nctmr4.png?enable-io=true&width=532"},
 averses_localis√©es:{label:"Averses Localis√©es",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/passages-pluvieux-high-qpysrh.png?enable-io=true&width=532"},
 pluie_faible:{label:"Pluie faible",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/pluie-faible-high-lwo4k5.png"},
 pluie_moderee:{label:"Pluie mod√©r√©e",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/pluie-mod-r-high-omk8vs.png"},
 pluie_forte:{label:"Forte pluie ‚ö†Ô∏è",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/pluie-forte-high.png?enable-io=true&width=532"},
 orage:{label:"Orages",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/orage-high-2ijlyg.png"},
 orage_isol√©:{label:"Risque d'orages isol√©es",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/passages-orageux-high-6ppgfs.png?enable-io=true&width=532"},
 orage_violent:{label:"Risque d'orages violents ‚ö†Ô∏è",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/orage-fort-high.png?enable-io=true&width=532"},
 neige_localis√©e:{label:"Neige localis√©e",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/neige-claircies-high-ajzfn1.png?enable-io=true&width=532"},
 neige_faible:{label:"Faibles chutes de neige",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/neige-faible-high-goeaq0.png"},
 neige_mod√©r√©:{label:"Chutes de neige mod√©r√©es",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/neige-mod-r-high-hw687j.png?enable-io=true&width=532"},
 neige_forte:{label:"Fortes chutes de neige ‚ö†Ô∏è",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/neige-forte-high.png?enable-io=true&width=532"},
 pluie_neige:{label:"Pluies et neige m√™l√©es",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/copie_de_copie_de_aesthetic_phone_mockup_instagram_post__9_-removebg-preview-high.png?enable-io=true&width=532"},
 vent_faible:{label:"Vent faible",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/logo_initiale_marron-_gourmand_-l-gant_minimaliste-removebg-preview-high.png"},
 vent_modere:{label:"Vent mod√©r√©",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/logo_initiale_marron-_gourmand_-l-gant_minimaliste__1_-removebg-preview-high-062t0p.png"},
 vent_fort:{label:"Vent fort",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/logo_initiale_marron-_gourmand_-l-gant_minimaliste__2_-removebg-preview-removebg-preview-high.png"},
 vent_tres_fort:{label:"Vent tr√®s fort",icon:"https://primary.jwwb.nl/public/q/t/q/temp-uozhroxmecrdemnjgoky/logo_initiale_marron-_gourmand_-l-gant_minimaliste__3_-removebg-preview-high.png"}
};
const CITIES = ["Rodez","Millau","Decazeville","Villefranche-de-Rouergue", "Belmont-sur-Rance", "Mur-de-Barrez", "V√©zins-de-L√©v√©zou", "R√©quista", "Saint-Ch√©ly-d'Aubrac"];
let currentPeriod = "morning";
let currentDate = new Date().toISOString().split("T")[0];
const tempData = {}; // stockage temporaire

// ---------------- LOGIN ----------------
const loginBtn = document.getElementById('login-btn');
const loginMessage = document.getElementById('login-message');
loginBtn.addEventListener('click', async () => {
  const email = document.getElementById('login-email').value;
  const password = document.getElementById('login-password').value;
  try {
    await signInWithEmailAndPassword(auth, email, password);
    loginMessage.innerText = "Connect√© !";
    document.getElementById('login-container').style.display = 'none';
    document.querySelector('.container').style.display = 'block';
    await initializeDashboard();
  } catch(error) {
    loginMessage.innerText = "Erreur : " + error.message;
  }
});

// ---------------- INITIALISATION ----------------
async function initializeDashboard(){
    // r√©cup√©rer displayedDay depuis Firebase
    const displayedSnap = await get(ref(db,'displayedDay'));
    if(displayedSnap.exists()){
        currentDate = displayedSnap.val();
    }

    const dateInput = document.getElementById('date-select');
    dateInput.value = currentDate;
    updateCurrentDateDisplay();

    // Charger toutes les donn√©es existantes pour cette date
    await loadAllDataForDate(currentDate);

    dateInput.addEventListener('change',()=> {
        currentDate = dateInput.value;
        renderCities();
        loadDescription();
        updateCurrentDateDisplay();
    });

    document.querySelectorAll('.period-btn').forEach(btn=>{
        btn.addEventListener('click',()=>{
            saveCurrentDescription();
            document.querySelectorAll('.period-btn').forEach(b=>b.classList.remove('btn-success'));
            btn.classList.add('btn-success');
            currentPeriod = btn.dataset.period;
            renderCities();
            loadDescription();
        });
    });

    renderCities();
    loadDescription();

    document.getElementById('save-all').addEventListener('click', saveAll);
}

// ---------------- AFFICHER DATE ----------------
function updateCurrentDateDisplay(){
    const dateDisplay = document.getElementById('current-date');
    const d = new Date(currentDate);
    dateDisplay.innerText = d.toLocaleDateString('fr-FR', { weekday:'long', day:'2-digit', month:'long' });
}

// ---------------- RENDER VILLES ----------------
const container = document.getElementById('cities-container');
function renderCities(){
 container.innerHTML='';
 CITIES.forEach(city=>{
  if(!tempData[currentDate]) tempData[currentDate]={};
  if(!tempData[currentDate][currentPeriod]) tempData[currentDate][currentPeriod]={};
  if(!tempData[currentDate][currentPeriod][city]) tempData[currentDate][currentPeriod][city]={condition:'soleil'};

  const col = document.createElement('div');
  col.className='col-md-3';
  col.innerHTML=`<div class="card p-2">
   <div class="mb-2"><strong>${city}</strong></div>
   <select class="form-select condition-select"></select>
   <img class="icon-preview mt-2" src="" alt="ic√¥ne"/>
  </div>`;
  container.appendChild(col);

  const select = col.querySelector('.condition-select');
  const img = col.querySelector('.icon-preview');

  Object.keys(CONDITIONS).forEach(key=>{
   const opt = document.createElement('option');
   opt.value=key; opt.text=CONDITIONS[key].label;
   select.appendChild(opt);
  });

  select.value = tempData[currentDate][currentPeriod][city].condition;
  img.src = CONDITIONS[select.value].icon;

  select.addEventListener('change',()=>{
      tempData[currentDate][currentPeriod][city].condition = select.value;
      img.src = CONDITIONS[select.value].icon;
  });
});
}

// ---------------- DESCRIPTION ----------------
const descTextarea = document.getElementById('description-text');
function loadDescription(){
    if(!tempData[currentDate]) tempData[currentDate]={};
    if(!tempData[currentDate][currentPeriod]) tempData[currentDate][currentPeriod]={};
    if(!tempData[currentDate][currentPeriod].text) tempData[currentDate][currentPeriod].text = '';

    descTextarea.value = tempData[currentDate][currentPeriod].text;

    descTextarea.oninput = ()=>{
        tempData[currentDate][currentPeriod].text = descTextarea.value;
    };
}

// ---------------- CHARGER TOUTES LES DONN√âES EXISTANTES ----------------
async function loadAllDataForDate(date){
    for(const period of ['morning','day','evening','wind']){
        for(const city of CITIES){
            const snap = await get(ref(db, `${date}/${period}/${city}`));
            if(snap.exists()){
                if(!tempData[date]) tempData[date]={};
                if(!tempData[date][period]) tempData[date][period]={};
                if(!tempData[date][period][city]) tempData[date][period][city]={};
                tempData[date][period][city].condition = snap.val();
            }
        }
        const descSnap = await get(ref(db, `descriptions/${date}/${period}`));
        if(descSnap.exists()){
            if(!tempData[date]) tempData[date]={};
            if(!tempData[date][period]) tempData[date][period]={};
            tempData[date][period].text = descSnap.val();
        }
    }
}

// ---------------- SAUVEGARDE ----------------
function saveCurrentDescription(){
    tempData[currentDate][currentPeriod].text = descTextarea.value;
}

async function saveAll(){
    saveCurrentDescription();
    if(!tempData[currentDate]) return;

    ['morning','day','evening','wind'].forEach(period=>{
        CITIES.forEach(city=>{
            if(tempData[currentDate][period] && tempData[currentDate][period][city]){
                set(ref(db, `${currentDate}/${period}/${city}`), tempData[currentDate][period][city].condition);
            }
        });
    });

    ['morning','day','evening','wind'].forEach(period=>{
        if(tempData[currentDate][period] && tempData[currentDate][period].text){
            set(ref(db, `descriptions/${currentDate}/${period}`), tempData[currentDate][period].text);
        }
    });

    set(ref(db,'displayedDay'), currentDate);
    alert(`Pr√©visions pour ${currentDate} sauvegard√©es !`);
}
</script>
</body>
</html>
